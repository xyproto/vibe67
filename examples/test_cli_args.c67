// Read CLI args from /proc/self/cmdline
import "libc.so.6" as c

main = {
    // Open file
    // O_RDONLY = 0
    fd := c.open("/proc/self/cmdline", 0 as int32)
    
    fd < 0 {
        println("Failed to open /proc/self/cmdline")
        ret 1
    }
    
    // Read content
    buf_size := 4096
    buf := c.malloc(buf_size as uint64)
    
    // Cast all args: int, void*, size_t
    bytes_read := c.read(fd as int32, buf as ptr, buf_size as uint64)
    c.close(fd as int32)
    
    println("Bytes read:", bytes_read)
    
    // Helper to read byte
    read_byte = (ptr, offset) -> {
        unsafe {
            rax <- ptr
            rbx <- offset
            rax <- rax + rbx
            rbx <- [rax] as uint8
            rax <- rbx
        } {
            x0 <- ptr
            x1 <- offset
            x0 <- x0 + x1
            x0 <- [x0] as uint8
        } {
            a0 <- ptr
            a1 <- offset
            a0 <- a0 + a1
            a0 <- [a0] as uint8
        }
    }
    
    print("Args: ")
    
    // Iterate bytes
    @ i in 0..<bytes_read max 4096 {
        b := read_byte(buf, i)
        
        b == 0 {
            // print(" ")
            c.printf(" ")
        }
        b != 0 {
            // Print char code
            c.printf("%c", b as int32)
        }
    }
    println("")
    
    c.free(buf)
    0
}