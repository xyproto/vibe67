import sdl3 as sdl

cstruct SDL_Event {
    type as uint32,
    timestamp as uint64
}

width = 620
height = 387

sdl.SDL_Init(sdl.SDL_INIT_VIDEO) or! {
    exitf("SDL_Init failed\n")
}
defer sdl.SDL_Quit()

window = sdl.SDL_CreateWindow("Test", width, height, 0) or! {
    exitf("Window failed\n")
}
defer sdl.SDL_DestroyWindow(window)

renderer = sdl.SDL_CreateRenderer(window, 0) or! {
    exitf("Renderer failed\n")
}
defer sdl.SDL_DestroyRenderer(renderer)

file = sdl.SDL_IOFromFile("img/grumpy-cat.bmp", "rb") or! {
    exitf("File failed\n")
}

bmp = sdl.SDL_LoadBMP_IO(file, 1) or! {
    exitf("BMP failed\n")
}
defer sdl.SDL_DestroySurface(bmp)

tex = sdl.SDL_CreateTextureFromSurface(renderer, bmp) or! {
    exitf("Texture failed\n")
}
defer sdl.SDL_DestroyTexture(tex)

running := 1
event := c.malloc(192) as SDL_Event
null_ptr := 0

@ running > 0 max 2 {
    has_event := sdl.SDL_PollEvent(event)
    sdl.SDL_RenderClear(renderer)
    sdl.SDL_RenderTexture(renderer, tex, null_ptr, null_ptr)
    sdl.SDL_RenderPresent(renderer)
    sdl.SDL_Delay(100)
    running = 0
}

println("Cleaning up")
